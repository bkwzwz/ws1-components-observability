<p>&nbsp;</p>
<p>&nbsp;</p>
<h1 id="overview">Overview</h1>
<p>This document can be used as a guidance on setting up tunnel server observability (Logging and Telemetry)</p>
<h1 id="architecture">Architecture</h1>
<p><img src="./docs/arch.png" alt="arch" /></p>
<h1 id="pre-reqs">Pre-reqs</h1>
<ul>
<li>Tunnel is configured on the Workspace ONE UEM Console. Follow the existing stems to configure syslog in the console and enable snmp (if using UAG).</li>
<li>Tunnel Server deployed via UAG or container.</li>
<li>All connectivity should be working as expected.</li>
</ul>
<h1 id="logging-and-telemetry">Logging and Telemetry</h1>
<h2 id="set-up">Set Up</h2>
<ul>
<li>Deploy Linux VM
<ul>
<li>Chose distribution of your choice, though Alma Linux is recommended for use. You can also choose to download <a href="https://almalinux.org/get-almalinux/">here</a>
<ul>
<li>Resource recommendation of Linux VM 4 core 16GB 100 GB storage</li>
<li>Retention policy
<ul>
<li>For Logs, 7 days of data is retained.</li>
</ul>
</li>
</ul>
</li>
<li>Ensure, docker and docker-compose is installed on Linux VM. Run <code>docker version</code> to confirm the same.</li>
<li>Start docker using <code>systemctl start docker</code></li>
</ul>
</li>
<li>If log storage is local, create a user <code>loki</code> where loki would write logs locally to, though it is not recommended to be used in production.</li>
<li>Clone the repo on Linux VM OR download to your local,zip the entire repo and transfer it to VM.</li>
<li>Login to VM</li>
<li>Go to directory where repo is cloned or unzip it if zipped.</li>
<li>open <a href="https://github.com/wsonetunnel/tunnel-server-observability/blob/main/.env">.env</a> file in this directory and fill in the below information</li>
</ul>
<pre><code class="hljs"><span class="hljs-attribute">TELEGRAF_HOST</span>=&lt;LINUX VM IP&gt;

<span class="hljs-attribute">INFLUXDB_HOST</span>=&lt;LINUX VM IP&gt;
<span class="hljs-attribute">INFLUXDB_PORT</span>=8086
<span class="hljs-attribute">DOCKER_INFLUXDB_INIT_MODE</span>=setup
<span class="hljs-attribute">DOCKER_INFLUXDB_INIT_USERNAME</span>=&lt;INFLUXDB USERNAME&gt;
<span class="hljs-attribute">DOCKER_INFLUXDB_INIT_PASSWORD</span>=&lt;INFLUXDB PASSWORD&gt;
<span class="hljs-attribute">DOCKER_INFLUXDB_INIT_ORG</span>=snmp
<span class="hljs-attribute">DOCKER_INFLUXDB_INIT_BUCKET</span>=metrics
<span class="hljs-attribute">DOCKER_INFLUXDB_INIT_ADMIN_TOKEN</span>=metrics

<span class="hljs-attribute">GRAFANA_PORT</span>=3000
<span class="hljs-attribute">GRAFANA_URL</span>=&lt;LINUX VM IP&gt; --&gt; <span class="hljs-keyword">Not</span> required <span class="hljs-keyword">if</span><span class="hljs-built_in"> customer </span>have their own Grafana Instance.
<span class="hljs-attribute">GRAFANA_USER</span>=&lt;GRAFANA USERNAME&gt;
<span class="hljs-attribute">GRAFANA_PASSWORD</span>=&lt;GRAFANA PASSWORD&gt;
<span class="hljs-attribute">GRAFANA_PLUGINS_ENABLED</span>=<span class="hljs-literal">true</span>
<span class="hljs-attribute">GRAFANA_PLUGINS</span>=grafana-piechart-panel

<span class="hljs-comment"># Define as "udp://&lt;hostname_or_ip1&gt;:161,udp://&lt;hostname_or_ip2&gt;:161,udp://&lt;hostname_or_ip3&gt;:161"</span>
<span class="hljs-attribute">SNMP_SERVERS</span>=&lt;TUNNEL<span class="hljs-built_in"> SERVER </span>IPS <span class="hljs-keyword">IN</span> ABOVE FORMAT&gt;</code></pre>
<ul>
<li>Run :</li>
</ul>
<pre><code class="hljs">setup.<span class="hljs-keyword">sh</span> with: 
    <span class="hljs-number">0</span>: <span class="hljs-keyword">if</span> <span class="hljs-keyword">all</span> components need <span class="hljs-keyword">to</span> run
    <span class="hljs-number">1</span>: <span class="hljs-keyword">if</span> everything except syslog needs <span class="hljs-keyword">to</span> <span class="hljs-keyword">be</span> deployed
    <span class="hljs-number">2</span>: <span class="hljs-keyword">if</span> everthing except syslog <span class="hljs-built_in">and</span> grafana needs <span class="hljs-keyword">to</span> <span class="hljs-keyword">be</span> deployed </code></pre>
<ul>
<li>If setup script above is run with mode 1, Make sure to make your syslog server forward logs to the Linux VM. Example syslog.conf</li>
</ul>
<pre><code class="hljs">destination d_loki {
    <span class="hljs-built_in">syslog</span>("&lt;LINUX VM IP&gt;" transport("tcp") <span class="hljs-built_in">port</span>("<span class="hljs-number">1514</span>"));
};

log {
        <span class="hljs-built_in">source</span>(s_local);
        <span class="hljs-built_in">source</span>(s_network);
        <span class="hljs-built_in">destination</span>(d_loki);
};</code></pre>
<ul>
<li>If setup script above is run with mode 2, apart from redirecting syslog logs as shown above, customer should add two datasources, loki(for logs) and influxdb(for metrics) retrieval. Refer <a href="https://github.com/wsonetunnel/tunnel-server-observability/blob/main/grafana/provisioning/datasources/loki.yaml">this</a> to configure datasource and <a href="https://github.com/wsonetunnel/tunnel-server-observability/blob/main/grafana/provisioning/dashboard/Monitoring.json">this</a> to see how to explore and view logs and metrics in your own grafana instance.</li>
<li>Open any browser on your local OR any machine which has connectivity to the Linux VM and type <code>http://&lt;linux-vm-ip&gt;:3000</code> or use your existing Grafana instance.
<ul>
<li>You can view the logs and stats here.</li>
</ul>
</li>
</ul>
<h2 id="configuration-for-application-and-access-logs">Configuration (for Application and Access Logs)</h2>
<ul>
<li>Configure syslog (Linux VM IP or URL/hostname) on UEM Console and save the configuration.
<ul>
<li>This will make tunnel server send access logs to observability stack. Assumption is the syslog server runs on port 514.</li>
<li>For application (tunnel server) logs, additional KVP settings can be configured. Starting Tunnel Server version 23.12, use below KVP to redirect tunnel application and reporter logs to syslog.</li>
<li>udp port 514 is supported.</li>
</ul>
</li>
</ul>
<p><img src="./docs/tunnelkvp.png" alt="Tunnel KVP" /></p>
<h2 id="configuration-for-telemetry">Configuration (for Telemetry)</h2>
<ul>
<li>Tunnel Server container already exposes port 161 for snmp stats.</li>
<li>In UAG, enable snmp following guide <a href="https://docs.vmware.com/en/Unified-Access-Gateway/2303/uag-deploy-config/GUID-F71E6283-E24B-49F5-8AC6-D28915CD41AD.html">here</a>.</li>
<li>Only snmp v2 is supported.</li>
<li>Update <code>SNMP_SERVERS</code> section in <a href="https://github.com/wsonetunnel/tunnel-server-observability/blob/main/.env">.env</a> to supply Tunnel Server IPs in the format <code>udp://&lt;hostname_or_ip1&gt;:161</code> for Observability stack to pull the snmp stats.</li>
</ul>
<h2 id="tests">Tests</h2>
<ol>
<li>Enroll a device and try accessing any tunnel&rsquo;ed resource from any enrolled device.</li>
<li>You should start seeing the logs and stats <code>http://&lt;linux-vm-ip&gt;:3000</code></li>
</ol>
<p><img src="./docs/grafana.png" alt="Tunnel Stats and Logs" /></p>
<h2 id="demo">Demo</h2>
<h1 id="setup">Setup</h1>
<p><strong>Setup</strong><br /> <img src="./docs/setup.gif" alt="Setup" /></p>
<hr />
<p><strong>Dashboard</strong><br /> <img src="./docs/ui.gif" alt="dashboard" /></p>
<h2 id="reference-documents">Further Notes</h2>
<p>Every observability stack needs to be reliable and for it to be, there are important factors must be considered to ensure the same(which is not what this document covers)</p>
<ul>
<li><strong>High Availability</strong>: Visualization tools like Grafana(or any other) needs to be robust of end user's interaction of the same. While container gives you a feel of how things look like, in reality, it is recommended for customers to have their own Grafana instance to attach things to and that is the reason <code>setup.sh</code> script talks about option 2, where Grafana won't be deployed.</li>
</ul>
<h2 id="reference-documents">Reference documents</h2>
<ul>
<li><a href="https://docs.vmware.com/en/VMware-Workspace-ONE-UEM/services/VMware_Tunnel/GUID-471260BA-4DDC-4BFE-B8C3-FA2DDC2116A1.html">Syslog Configuration</a></li>
<li><a href="https://docs.vmware.com/en/Unified-Access-Gateway/2303/uag-deploy-config/GUID-F71E6283-E24B-49F5-8AC6-D28915CD41AD.html">SNMP Configuration in UAG</a></li>
<li><a href="https://github.com/lux4rd0/grafana-loki-syslog-aio">Syslog AIO</a></li>
<li><a href="https://github.com/wsonetunnel/tunnel-server-observability">Github Repo for Tunnel Server Observability</a></li>
</ul>
